import {
    http,
    type Address,
    type Hex,
    concat,
    createPublicClient,
    getCreate2Address,
    encodeFunctionData,
    toHex,
    parseAbi
} from "viem"
import { foundry } from "viem/chains"
import { getAnvilWalletClient } from "./utils/index.js"

// https://github.com/Vectorized/solady/blob/main/test/utils/mocks/MockERC1155.sol
const MOCK_ERC1155_BYTECODE: Hex =
    "0x6080604052348015600f57600080fd5b50611a388061001f6000396000f3fe608060405234801561001057600080fd5b506004361061016a5760003560e01c806372f5762d116100cd578063b48ab8b611610081578063f242432a11610066578063f242432a14610338578063f5298aca1461034b578063f6eb127a1461035e57600080fd5b8063b48ab8b6146102f9578063e985e9c51461030c57600080fd5b806378614f0f116100b257806378614f0f146102c057806383de5e6a146102d3578063a22cb465146102e657600080fd5b806372f5762d1461029a578063731133e9146102ad57600080fd5b80632eb2c2d6116101245780634e1273f4116101095780634e1273f4146102545780634f05263e14610274578063518066d81461028757600080fd5b80632eb2c2d61461023857806345e239861461024b57600080fd5b806301ffc9a71161015557806301ffc9a7146101c45780630e89341c1461020457806310b0654e1461022557600080fd5b8062de176b1461016f578062fdd58e14610184575b600080fd5b61018261017d36600461137f565b610371565b005b6101b1610192366004611435565b679a31110384e0b0c96020526014919091526000908152604090205490565b6040519081526020015b60405180910390f35b6101f46101d236600461145f565b6301ffc9a760e09190911c90811463d9b67a26821417630e89341c9091141790565b60405190151581526020016101bb565b6102186102123660046114a8565b50606090565b6040516101bb91906114c1565b61018261023336600461137f565b6103a8565b61018261024636600461159d565b6103b5565b6101b160005481565b610267610262366004611664565b6103fb565b6040516101bb91906116d5565b610182610282366004611718565b61046b565b610182610295366004611771565b610492565b6101826102a83660046117ad565b6104b1565b6101826102bb3660046117e0565b6104c9565b6101826102ce366004611718565b6104ed565b6101826102e1366004611841565b6104f9565b6101826102f4366004611771565b61050c565b6101826103073660046118ba565b610562565b6101f461031a366004611947565b679a31110384e0b0c96020526014919091526000526034600c205490565b61018261034636600461197a565b610576565b6101826103593660046117ad565b6105b8565b61018261036c366004611841565b6105d4565b61039761037d336105f0565b610386876105f0565b61038f876105f0565b86868661061f565b805160209091012060005550505050565b61039761037d60006105f0565b6103d56103c1896105f0565b6103ca896105f0565b8888888888886107a4565b81816040516103e59291906119f2565b6040519081900390206000555050505050505050565b606083821461041257633b800a466000526004601cfd5b6040519050818152602081018260051b8181016040525b801561046157602081039050808701358060601b679a31110384e0b0c917602052508085013560005260406000205481830152610429565b5050949350505050565b61039761047860006105f0565b610481876105f0565b61048a876105f0565b8686866109d5565b6104ad61049e336105f0565b6104a7846105f0565b83610b1c565b5050565b6104c46104bd846105f0565b8383610b78565b505050565b6104dd6104d5856105f0565b848484610b85565b8051602090910120600055505050565b610397610478336105f0565b6104c4610505846105f0565b8383610c1d565b8015159050679a31110384e0b0c96020523360145281600052806034600c2055806000528160601b60601c337f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c3160206000a35050565b6104dd61056e856105f0565b848484610c2a565b610594610582876105f0565b61058b876105f0565b86868686610d3d565b81816040516105a49291906119f2565b604051908190039020600055505050505050565b6104c46105c4336105f0565b6105cd856105f0565b8484610ea6565b6104c46105e0336105f0565b6105e9856105f0565b8484610f43565b600073ffffffffffffffffffffffffffffffffffffffff82168060a06106158261106f565b901b189392505050565b815183511461063657633b800a466000526004601cfd5b8460601b8460601b806106515763ea553b346000526004601cfd5b81679a31110384e0b0c91781679a31110384e0b0c917816020528960601b848114811517610695578a6000526034600c205461069557634b6e7f186000526004601cfd5b50865160051b5b80156107065780870151836020528189015160005260406000208054808311156106ce5763f4d678b86000526004601cfd5b8290039055602083905260406000208054808301818110156106f8576301336cea6000526004601cfd5b9091555050601f190161069c565b50505060405160408152855160051b602001604082018181838a60045afa503d60400160208401523d81019050865160051b60200191508181838960045afa50823d8201039150508260601c8460601c337f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8486a450505050610787600090565b50833b1561079c5761079c85858585856110ba565b505050505050565b8285146107b957633b800a466000526004601cfd5b8760601b679a31110384e0b0c9178760601b679a31110384e0b0c917816020528160601c99508060601c9850886107f85763ea553b346000526004601cfd5b89331461081b57336000526034600c205461081b57634b6e7f186000526004601cfd5b8660051b5b801561088d576020810390508087013583602052818a013560005260406000208054808311156108585763f4d678b86000526004601cfd5b829003905560208390526040600020805480830181811015610882576301336cea6000526004601cfd5b909155506108209050565b505050604051604081528560051b866040830152808860608401378060600160208301526060818301018781528187602083013750888a337f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb60808586010186a450506108f8600090565b1561090d5761090d8888888888888888611176565b863b156109cb578660005260405163bc197c81815233602082015288604082015260a060608201528560051b8660c0830152808860e08401378060c001608083015260e08183010187815281876020830137818260e0010160a084015260208282010190508381528385602083013750808101830161010401905060208282601c60405101600080515af16109ab573d156109ab573d6000833e3d82fd5b50805163bc197c8160e01b146109c957639c05499b6000526004601cfd5b505b5050505050505050565b6109f6565b6040805180820190915260018152602081018790525b50505050565b8460601b8460601b80610a115763ea553b346000526004601cfd5b81679a31110384e0b0c9176020528760601b828114811517610a4957886000526034600c2054610a4957634b6e7f186000526004601cfd5b50846000526040600020805480861115610a6b5763f4d678b86000526004601cfd5b8590039055679a31110384e0b0c981176020526040600020805480860181811015610a9e576301336cea6000526004601cfd5b808355505050836020528060601c8260601c337fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f6260406000a45050610ae1600090565b15610b0857610b0885856109da866040805180820190915260018152602081019190915290565b833b1561079c5761079c858585858561117b565b8015159050679a31110384e0b0c96020528260145281600052806034600c20558060005260001960601c8281168482167f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c3160206000a350505050565b6104c46000848484610ea6565b8360601b80610b9c5763ea553b346000526004601cfd5b679a31110384e0b0c960205284601452836000526040600020805484810181811015610bd0576301336cea6000526004601cfd5b808355505050826020528060601c6000337fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f6260406000a450833b156109f0576109f060008585858561117b565b6104c46000848484610f43565b8151835114610c4157633b800a466000526004601cfd5b8360601b80610c585763ea553b346000526004601cfd5b80679a31110384e0b0c917602052835160051b5b8015610cab5780840151818601516000526040600020805482810181811015610c9d576301336cea6000526004601cfd5b9091555050601f1901610c6c565b5060405160408152845160051b602001604082018181838960045afa503d60400160208401523d81019050855160051b60200191508181838860045afa50823d8201039150508260601c6000337f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8486a4505050610d27600090565b50833b156109f0576109f06000858585856110ba565b8560601b679a31110384e0b0c9178560601b679a31110384e0b0c917816020528160601c97508060601c965086610d7c5763ea553b346000526004601cfd5b873314610d9f57336000526034600c2054610d9f57634b6e7f186000526004601cfd5b8560005260406000209150815480861115610dc25763f4d678b86000526004601cfd5b8581038355508060205260406000209150815485810181811015610dee576301336cea6000526004601cfd5b909255505060208390528486337fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f6260406000a4843b1561079c5760405163f23a6e61815233602082015286604082015284606082015283608082015260a0808201528160c0820152818360e08301376020818360c401601c840160008a5af1610e80573d15610e80573d6000823e3d81fd5b805163f23a6e6160e01b14610e9d57639c05499b6000526004601cfd5b50505050505050565b8260601b80679a31110384e0b0c917602052808560601b148560601b1517610ee457846000526034600c2054610ee457634b6e7f186000526004601cfd5b826000526040600020805480841115610f055763f4d678b86000526004601cfd5b838103825550508160205260008160601c337fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f6260406000a4506109f0565b8051825114610f5a57633b800a466000526004601cfd5b8260601b80679a31110384e0b0c9176020528460601b818114811517610f9657856000526034600c2054610f9657634b6e7f186000526004601cfd5b50825160051b5b8015610fda5780830151818501516000526040600020805480831115610fcb5763f4d678b86000526004601cfd5b919091039055601f1901610f9d565b5060405160408152835160051b602001604082018181838860045afa503d60400160208401523d81019050845160051b60200191508181838760045afa50823d82010391505060008360601c337f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8486a4505050611056600090565b156109f0576040805160208101909152600090526109f0565b60405136600082373681206020526010518218601052608860002090508060105260bc19700100000000000000000000000000000051820960801c6007166110b5575060005b919050565b60405163bc197c8181523360208201528560601b60601c604082015260a06060820152835160051b60200160c082018181838860045afa503d60a0018060808501523d82019150855160051b60200192508282848860045afa503d0160a0840152835160200191503d018181818660045afa50601c83013d82010391505060208282601c850160008a5af1611158573d15611158573d6000833e3d82fd5b50805163bc197c8160e01b1461079c57639c05499b6000526004601cfd5b6109cb565b60405163f23a6e6181523360208201528560601b60601c604082015283606082015282608082015260a08082015281518060c083015280156111c7578060e08301826020860160045afa505b6020828260c401601c850160008a5af16111ea573d156111ea573d6000833e3d82fd5b50805163f23a6e6160e01b1461079c57639c05499b6000526004601cfd5b803573ffffffffffffffffffffffffffffffffffffffff811681146110b557600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff811182821017156112845761128461122c565b604052919050565b600082601f83011261129d57600080fd5b813567ffffffffffffffff8111156112b7576112b761122c565b8060051b6112c76020820161125b565b918252602081850181019290810190868411156112e357600080fd5b6020860192505b838310156113055782358252602092830192909101906112ea565b9695505050505050565b600082601f83011261132057600080fd5b813567ffffffffffffffff81111561133a5761133a61122c565b61134d601f8201601f191660200161125b565b81815284602083860101111561136257600080fd5b816020850160208301376000918101602001919091529392505050565b600080600080600060a0868803121561139757600080fd5b6113a086611208565b94506113ae60208701611208565b9350604086013567ffffffffffffffff8111156113ca57600080fd5b6113d68882890161128c565b935050606086013567ffffffffffffffff8111156113f357600080fd5b6113ff8882890161128c565b925050608086013567ffffffffffffffff81111561141c57600080fd5b6114288882890161130f565b9150509295509295909350565b6000806040838503121561144857600080fd5b61145183611208565b946020939093013593505050565b60006020828403121561147157600080fd5b81357fffffffff00000000000000000000000000000000000000000000000000000000811681146114a157600080fd5b9392505050565b6000602082840312156114ba57600080fd5b5035919050565b602081526000825180602084015260005b818110156114ef57602081860181015160408684010152016114d2565b506000604082850101526040601f19601f83011684010191505092915050565b60008083601f84011261152157600080fd5b50813567ffffffffffffffff81111561153957600080fd5b6020830191508360208260051b850101111561155457600080fd5b9250929050565b60008083601f84011261156d57600080fd5b50813567ffffffffffffffff81111561158557600080fd5b60208301915083602082850101111561155457600080fd5b60008060008060008060008060a0898b0312156115b957600080fd5b6115c289611208565b97506115d060208a01611208565b9650604089013567ffffffffffffffff8111156115ec57600080fd5b6115f88b828c0161150f565b909750955050606089013567ffffffffffffffff81111561161857600080fd5b6116248b828c0161150f565b909550935050608089013567ffffffffffffffff81111561164457600080fd5b6116508b828c0161155b565b999c989b5096995094979396929594505050565b6000806000806040858703121561167a57600080fd5b843567ffffffffffffffff81111561169157600080fd5b61169d8782880161150f565b909550935050602085013567ffffffffffffffff8111156116bd57600080fd5b6116c98782880161150f565b95989497509550505050565b602080825282518282018190526000918401906040840190835b8181101561170d5783518352602093840193909201916001016116ef565b509095945050505050565b600080600080600060a0868803121561173057600080fd5b61173986611208565b945061174760208701611208565b93506040860135925060608601359150608086013567ffffffffffffffff81111561141c57600080fd5b6000806040838503121561178457600080fd5b61178d83611208565b9150602083013580151581146117a257600080fd5b809150509250929050565b6000806000606084860312156117c257600080fd5b6117cb84611208565b95602085013595506040909401359392505050565b600080600080608085870312156117f657600080fd5b6117ff85611208565b93506020850135925060408501359150606085013567ffffffffffffffff81111561182957600080fd5b6118358782880161130f565b91505092959194509250565b60008060006060848603121561185657600080fd5b61185f84611208565b9250602084013567ffffffffffffffff81111561187b57600080fd5b6118878682870161128c565b925050604084013567ffffffffffffffff8111156118a457600080fd5b6118b08682870161128c565b9150509250925092565b600080600080608085870312156118d057600080fd5b6118d985611208565b9350602085013567ffffffffffffffff8111156118f557600080fd5b6119018782880161128c565b935050604085013567ffffffffffffffff81111561191e57600080fd5b61192a8782880161128c565b925050606085013567ffffffffffffffff81111561182957600080fd5b6000806040838503121561195a57600080fd5b61196383611208565b915061197160208401611208565b90509250929050565b60008060008060008060a0878903121561199357600080fd5b61199c87611208565b95506119aa60208801611208565b94506040870135935060608701359250608087013567ffffffffffffffff8111156119d457600080fd5b6119e089828a0161155b565b979a9699509497509295939492505050565b818382376000910190815291905056fea264697066735822122084fd4abd60223ab306e64ad1fc978064849aae6ebf883648df113a362506843d64736f6c634300081c0033"

export const deployMockERC1155 = async ({
    anvilRpc
}: {
    anvilRpc: string
}): Promise<Address> => {
    const publicClient = createPublicClient({
        transport: http(anvilRpc),
        chain: foundry
    })

    // Deploy mock ERC1155 contract
    const walletClient = getAnvilWalletClient({
        addressIndex: 0,
        anvilRpc
    })

    const counterFactual = getCreate2Address({
        from: "0x4e59b44847b379578588920ca78fbf26c0b4956c",
        salt: toHex(0, { size: 32 }),
        bytecode: MOCK_ERC1155_BYTECODE
    })

    const bytecode = await publicClient.getCode({
        address: counterFactual
    })

    if (!bytecode || bytecode === "0x") {
        // If it doesn't exist, deploy it
        await walletClient.sendTransaction({
            data: concat([
                "0x0000000000000000000000000000000000000000000000000000000000000000",
                MOCK_ERC1155_BYTECODE
            ]),
            to: "0x4e59b44847b379578588920ca78fbf26c0b4956c"
        })
    }

    return counterFactual
}

// Mint a token to the specified address
export const mintERC1155 = async ({
    contractAddress,
    to,
    tokenId,
    amount,
    anvilRpc
}: {
    contractAddress: Address
    to: Address
    tokenId: bigint
    amount: bigint
    anvilRpc: string
}): Promise<Hex> => {
    const walletClient = getAnvilWalletClient({
        addressIndex: 0,
        anvilRpc
    })

    const tx = await walletClient.sendTransaction({
        to: contractAddress,
        data: encodeFunctionData({
            abi: parseAbi([
                "function mint(address to, uint256 id, uint256 amount, bytes memory data)"
            ]),
            functionName: "mint",
            args: [to, tokenId, amount, "0x"]
        })
    })

    return tx
}
