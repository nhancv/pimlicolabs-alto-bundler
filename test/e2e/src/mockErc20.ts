import {
    http,
    type Address,
    type Hex,
    concat,
    createPublicClient,
    getCreate2Address,
    encodeFunctionData,
    toHex,
    parseAbi
} from "viem"
import { foundry } from "viem/chains"
import { getAnvilWalletClient } from "./utils/index.js"

// https://github.com/Vectorized/solady/blob/main/test/utils/mocks/MockERC20.sol
const MOCK_ERC20_BYTECODE: Hex =
    "0x60a060405234801561001057600080fd5b50604051610fcb380380610fcb83398101604081905261002f91610127565b600061003b8482610233565b5060016100488382610233565b506002805460ff191660ff929092169190911790555080516020909101206080526102f1565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261009557600080fd5b81516001600160401b038111156100ae576100ae61006e565b604051601f8201601f19908116603f011681016001600160401b03811182821017156100dc576100dc61006e565b6040528181528382016020018510156100f457600080fd5b60005b82811015610113576020818601810151838301820152016100f7565b506000918101602001919091529392505050565b60008060006060848603121561013c57600080fd5b83516001600160401b0381111561015257600080fd5b61015e86828701610084565b602086015190945090506001600160401b0381111561017c57600080fd5b61018886828701610084565b925050604084015160ff8116811461019f57600080fd5b809150509250925092565b600181811c908216806101be57607f821691505b6020821081036101de57634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561022e57806000526020600020601f840160051c8101602085101561020b5750805b601f840160051c820191505b8181101561022b5760008155600101610217565b50505b505050565b81516001600160401b0381111561024c5761024c61006e565b6102608161025a84546101aa565b846101e4565b6020601f821160018114610294576000831561027c5750848201515b600019600385901b1c1916600184901b17845561022b565b600084815260208120601f198516915b828110156102c457878501518255602094850194600190920191016102a4565b50848210156102e25786840151600019600387901b60f8161c191681555b50505050600190811b01905550565b608051610cb8610313600039600081816103ab01526104ef0152610cb86000f3fe608060405234801561001057600080fd5b50600436106101005760003560e01c80637ecebe0011610097578063d30ed3b311610066578063d30ed3b31461021f578063d505accf14610232578063dd62ed3e14610245578063f83d17911461025857600080fd5b80637ecebe00146101cb57806395d89b41146101f15780639dc29fac146101f9578063a9059cbb1461020c57600080fd5b8063313ce567116100d3578063313ce567146101735780633644e5151461018857806340c10f191461019057806370a08231146101a557600080fd5b806306fdde0314610105578063095ea7b31461012357806318160ddd1461014657806323b872dd14610160575b600080fd5b61010d61026b565b60405161011a9190610aa2565b60405180910390f35b610136610131366004610b07565b6102fd565b604051901515815260200161011a565b6805345cdf77eb68f44c545b60405190815260200161011a565b61013661016e366004610b31565b610382565b60025460405160ff909116815260200161011a565b6101526103a7565b6101a361019e366004610b07565b61044a565b005b6101526101b3366004610b6e565b6387a211a2600c908152600091909152602090205490565b6101526101d9366004610b6e565b6338377508600c908152600091909152602090205490565b61010d610460565b6101a3610207366004610b07565b61046f565b61013661021a366004610b07565b610481565b6101a361022d366004610b31565b61049c565b6101a3610240366004610b89565b6104bc565b610152610253366004610bfc565b6106ae565b6101a3610266366004610b31565b6106f5565b60606000805461027a90610c2f565b80601f01602080910402602001604051908101604052809291908181526020018280546102a690610c2f565b80156102f35780601f106102c8576101008083540402835291602001916102f3565b820191906000526020600020905b8154815290600101906020018083116102d657829003601f168201915b5050505050905090565b60006001600160a01b0383166e22d473030f116ddee9f6b43ac78ba3188219151761033057633f68539a6000526004601cfd5b82602052637f5e9f20600c5233600052816034600c205581600052602c5160601c337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560206000a35060015b92915050565b600061039f61039085610710565b61039985610710565b84610732565b949350505050565b60007f0000000000000000000000000000000000000000000000000000000000000000806103e1576103d761026b565b8051906020012090505b604080517f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f815260208101929092527fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc69082015246606082015230608082015260a09020919050565b61045c61045683610710565b82610805565b5050565b60606001805461027a90610c2f565b61045c61047b83610710565b82610884565b600061049561048f84610710565b836108fb565b9392505050565b6104b76104a884610710565b6104b184610710565b83610976565b505050565b6001600160a01b0386166e22d473030f116ddee9f6b43ac78ba318851915176104ed57633f68539a6000526004601cfd5b7f0000000000000000000000000000000000000000000000000000000000000000806105255761051b61026b565b8051906020012090505b7fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc64286101561055c57631a15a3cc6000526004601cfd5b6040518960601b60601c99508860601b60601c985065383775081901600e52896000526020600c2080547f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f835284602084015283604084015246606084015230608084015260a08320602e527f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c983528b60208401528a60408401528960608401528060808401528860a084015260c08320604e526042602c206000528760ff1660205286604052856060526020806080600060015afa8c3d51146106485763ddafbaef6000526004601cfd5b019055777f5e9f20000000000000000000000000000000000000000089176040526034602c20889055888a7f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925602060608501a36040525050600060605250505050505050565b60006e22d473030f116ddee9f6b43ac78ba2196001600160a01b038316016106d9575060001961037c565b50602052637f5e9f20600c908152600091909152603490205490565b6104b761070184610710565b61070a84610710565b836109dc565b60006001600160a01b0382168060a061072882610a57565b901b189392505050565b60008360601b6e22d473030f116ddee9f6b43ac78ba333146107895733602052637f5e9f208117600c526034600c2080548019156107865780851115610780576313be252b6000526004601cfd5b84810382555b50505b6387a211a28117600c526020600c208054808511156107b05763f4d678b86000526004601cfd5b84810382555050836000526020600c208381540181555082602052600c5160601c8160601c7fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602080a3505060019392505050565b6805345cdf77eb68f44c54818101818110156108295763e5cfe9576000526004601cfd5b806805345cdf77eb68f44c5550506387a211a2600c52816000526020600c208181540181555080602052600c5160601c60007fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602080a35050565b6387a211a2600c52816000526020600c208054808311156108ad5763f4d678b86000526004601cfd5b82900390556805345cdf77eb68f44c8054829003905560008181526001600160a01b0383167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602083a35050565b60006387a211a2600c52336000526020600c208054808411156109265763f4d678b86000526004601cfd5b83810382555050826000526020600c208281540181555081602052600c5160601c337fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602080a350600192915050565b6e22d473030f116ddee9f6b43ac78ba2196001600160a01b0383160161099b57505050565b81602052637f5e9f20600c52826000526034600c2080548019156109d557808311156109cf576313be252b6000526004601cfd5b82810382555b5050505050565b8260601b6387a211a28117600c526020600c20805480841115610a075763f4d678b86000526004601cfd5b83810382555050826000526020600c208281540181555081602052600c5160601c8160601c7fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602080a350505050565b60405136600082373681206020526010518218601052608860002090508060105260bc19700100000000000000000000000000000051820960801c600716610a9d575060005b919050565b602081526000825180602084015260005b81811015610ad05760208186018101516040868401015201610ab3565b506000604082850101526040601f19601f83011684010191505092915050565b80356001600160a01b0381168114610a9d57600080fd5b60008060408385031215610b1a57600080fd5b610b2383610af0565b946020939093013593505050565b600080600060608486031215610b4657600080fd5b610b4f84610af0565b9250610b5d60208501610af0565b929592945050506040919091013590565b600060208284031215610b8057600080fd5b61049582610af0565b600080600080600080600060e0888a031215610ba457600080fd5b610bad88610af0565b9650610bbb60208901610af0565b95506040880135945060608801359350608088013560ff81168114610bdf57600080fd5b9699959850939692959460a0840135945060c09093013592915050565b60008060408385031215610c0f57600080fd5b610c1883610af0565b9150610c2660208401610af0565b90509250929050565b600181811c90821680610c4357607f821691505b602082108103610c7c577f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b5091905056fea26469706673582212202af556fb3779b80a427ab7487237ce5354bf8e2c23204fb0f2df3bbda219b3fe64736f6c634300081c0033"

export const deployMockERC20 = async ({
    anvilRpc
}: {
    anvilRpc: string
}): Promise<Address> => {
    const publicClient = createPublicClient({
        transport: http(anvilRpc),
        chain: foundry
    })

    // Deploy mock ERC20 contract
    const walletClient = getAnvilWalletClient({
        addressIndex: 0,
        anvilRpc
    })

    const counterFactual = getCreate2Address({
        from: "0x4e59b44847b379578588920ca78fbf26c0b4956c",
        salt: toHex(0, { size: 32 }),
        bytecode: MOCK_ERC20_BYTECODE
    })

    const bytecode = await publicClient.getCode({
        address: counterFactual
    })

    if (!bytecode || bytecode === "0x") {
        // If it doesn't exist, deploy it
        await walletClient.sendTransaction({
            data: concat([
                "0x0000000000000000000000000000000000000000000000000000000000000000",
                MOCK_ERC20_BYTECODE
            ]),
            to: "0x4e59b44847b379578588920ca78fbf26c0b4956c"
        })
    }

    return counterFactual
}

// Mint a token to the specified address
export const mintERC20 = async ({
    contractAddress,
    to,
    amount,
    anvilRpc
}: {
    contractAddress: Address
    to: Address
    amount: bigint
    anvilRpc: string
}): Promise<Hex> => {
    const walletClient = getAnvilWalletClient({
        addressIndex: 0,
        anvilRpc
    })

    const tx = await walletClient.sendTransaction({
        to: contractAddress,
        data: encodeFunctionData({
            abi: parseAbi(["function mint(address to, uint256 id)"]),
            functionName: "mint",
            args: [to, amount]
        })
    })

    return tx
}
